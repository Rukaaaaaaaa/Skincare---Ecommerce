<!DOCTYPE html>
<html lang="en">
<head>
    <title>Beautya - Skincare & Makeup</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>

        .checkout-container {
            max-width: 1000px;
            margin: auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        h1 {
            font-size: 32px;
            color: #c80064;
            margin-bottom: 40px;
            text-align: center;
            font-weight: 700;
        }

        .address-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .address-input label {
            font-weight: 600;
            display: block;
            margin: 10px 0 6px;
            color: #444;
        }

        .address-input select,
        .address-input input[type="text"],
        .address-input input[type="tel"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            transition: border-color 0.3s ease;
        }

        .address-input select:focus,
        .address-input input:focus {
            outline: none;
            border-color: #c80064;
            box-shadow: 0 0 5px rgba(200, 0, 100, 0.2);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;

        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #555;
        }

        td:first-child, th:first-child {
            text-align: left;
        }

        td img {
            width: 60px;
            height: 60px;
            vertical-align: middle;
            border-radius: 8px;
            margin-right: 12px;
            object-fit: cover;
        }

        .qty-input {
            width: 70px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: border-color 0.3s ease;
        }

        .qty-input:focus {
            border-color: #c80064;
            outline: none;
        }

        .shipping-method {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .shipping-method h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        .shipping-option {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            background-color: #fff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .shipping-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .shipping-option input {
            margin-right: 12px;
        }

        .coupon-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 30px 0;
        }

        .coupon-section select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            flex: 1;
            transition: border-color 0.3s ease;
        }

        .coupon-section select:focus {
            border-color: #c80064;
            outline: none;
        }

        .coupon-section button {
            background-color: #c80064;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .coupon-section button:hover {
            background-color: #a60053;
        }

        .payment-method {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .payment-method h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        .payment-option {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            background-color: #fff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .payment-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .payment-option input {
            margin-right: 12px;
        }

        .cart-summary {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .cart-summary h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        .cart-summary p {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 16px;
        }

        .cart-summary p strong {
            color: #c80064;
        }
        .summary-total {
          color: #c80064;
        }

        .cart-summary button {
            margin-top: 20px;
            width: 100%;
            padding: 14px;
            background-color: #c80064;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .cart-summary button:hover {
            background-color: #a60053;
        }

        /* Modal Styles for QR Popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            max-width: 400px;
            width: 90%;
        }

        .modal-content img {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        .modal-content p {
            margin: 0 0 20px;
            font-size: 16px;
            color: #333;
        }

        @media (max-width: 768px) {
            .checkout-container {
                margin: 20px;
                padding: 20px;
            }

            .address-input {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 24px;
            }

            table {
                font-size: 14px;
            }

            td img {
                width: 50px;
                height: 50px;
            }

            .modal-content img {
                max-width: 150px;
            }
        }

    </style>
</head>
{% load static %}
{% load humanize %}
<form method="post" action="{% url 'checkout' %}">
{% csrf_token %}
<body>
  <header class="header">
    <div class="logo">
      <img src="{% static 'img/unsplash_HvkDYluePqw.png' %}" alt="LOGO" />
      <span class="shop-name">BEAUTYA</span>
    </div>
    <nav class="nav-menu">
      <a href="{% url 'home' %}" class="nav-link">Home</a>
      <a href="{% url 'product_list' %}" class="nav-link">Products</a>
      <a href="{% url 'about' %}" class="nav-link">About Us</a>
      <a href="{% url 'contact' %}" class="nav-link">Contacts</a>
      <a href="{% url 'login' %}" class="nav-link">Sign in</a>
    </nav>
    <div class="header-actions">
      <div class="cart-wrapper">
        <i class="fas fa-shopping-cart cart-icon" onclick="window.location.href='cart.html'"></i>
        <span class="cart-count">{{ cart_items|length }}</span>
      </div>
      <i class="fa-solid fa-magnifying-glass search-icon"></i>
    </div>
  </header>

  <div class="checkout-container">
    <h1>Thanh Toán</h1>
    <div class="address-input">
      <div><label>Họ và Tên</label><input type="text" name="fullname" required></div>
      <div><label>Số điện thoại</label><input type="tel" name="phone" required></div>
      <div><label>Tỉnh / Thành phố</label><input type="text" name="province" required></div>
      <div><label>Quận / Huyện</label><input type="text" name="district" required></div>
      <div class="full-width"><label>Xã / Phường / Thị trấn</label><input type="text" name="ward" required></div>
      <div class="full-width"><label>Địa chỉ cụ thể</label><input type="text" name="detail-address" required></div>
    </div>

    <table>
      <thead>
        <tr><th>Sản phẩm</th><th>Giá</th><th>Số lượng</th><th>Tổng</th></tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr>
          <td><img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"> {{ item.product.name }}</td>
          <td>{{ item.product.price|intcomma }}<small>đ</small></td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.subtotal|intcomma }}<small>đ</small></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="shipping-method">
      <h3>Phương thức vận chuyển</h3>
      <label><input type="radio" name="shipping-method" value="20000" checked> Giao nhanh 20.000đ</label>
      <label><input type="radio" name="shipping-method" value="100000"> Giao hỏa tốc 100.000đ</label>
    </div>

    <div class="coupon-section">
      <select name="coupon">
        <option value="">-- Chọn mã giảm giá --</option>
        <option value="freeship">Miễn phí vận chuyển</option>
        <option value="discount10k">Giảm 10.000đ</option>
      </select>
    </div>

    <div class="payment-method">
      <h3>Phương thức thanh toán</h3>
      <label><input type="radio" name="payment-method" value="cod" checked> COD</label>
      <label><input type="radio" name="payment-method" value="bank"> Ngân hàng</label>
      <label><input type="radio" name="payment-method" value="momo"> MoMo</label>
    </div>

    <div class="cart-summary">
      <h3>Tổng đơn hàng</h3>
      <p><span>Tổng tiền hàng:</span><span>{{ total|intcomma }}đ</span></p>
      <p><span>Phí vận chuyển:</span><span id="shipping_display">0đ</span></p>
      <p><span>Giảm giá:</span><span id="discount_display">0đ</span></p>
      <p><strong><span>Tổng cộng:</span><span id="total_display">{{ total|intcomma }}đ</span></strong></p>

      <input type="hidden" name="shipping_fee" id="shipping_fee" value="20000">
      <input type="hidden" name="discount" id="discount" value="0">
      <input type="hidden" name="total" id="total_price" value="{{ total }}">

      <button type="submit">Đặt hàng</button>
    </div>
  </div>

    <!-- Modal for QR Code -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <p id="modal-title">Quét mã QR để thanh toán</p>
            <img id="qr-image" src="" alt="QR Code">
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-top">
            <div class="benefit-item">
                <i class="fas fa-paw benefit-icon"></i>
                <span class="benefit-text">Không thử nghiệm trên động vật</span>
            </div>
            <div class="benefit-item">
                <i class="fas fa-leaf benefit-icon"></i>
                <span class="benefit-text">Không có thành phần từ động vật</span>
            </div>
            <div class="benefit-item">
                <i class="fas fa-bread-slice benefit-icon"></i>
                <span class="benefit-text">Không có gluten, hoặc sản phẩm phụ từ gluten</span>
            </div>
            <div class="benefit-item">
                <i class="fas fa-recycle benefit-icon"></i>
                <span class="benefit-text">Bao bì có thể tái chế</span>
            </div>
        </div>

        <div class="footer-main">
            <div class="footer-column">
                <h3>Chúng tôi có thể giúp gì?</h3>
                <ul>
                    <li><a href="#">Beautya branches</a></li>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">FAQ</a></li>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Blog</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Products</h3>
                <ul>
                    <li><a href="#">Chính Sách Bảo Mật</a></li>
                    <li><a href="#">Chính Sách Bảo Hành</a></li>
                    <li><a href="#">Trả Hàng/Hoàn Tiền</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Giữ liên lạc với Beautya</h3>
                <p style="color: white; margin-bottom: 24px">
                    Hãy tham gia nhận bản tin của Beautya để là người đầu tiên biết về tin tức, ưu đãi và lời khuyên chăm sóc da.
                </p>
                <form class="newsletter-form">
                    <input type="email" placeholder="Email" class="newsletter-input" />
                    <button type="submit" class="newsletter-submit">Subscribe</button>
                </form>
                <label class="consent-text">
                    <input type="checkbox" required>
                    Bằng cách gửi email của bạn, bạn đồng ý nhận các email quảng cáo từ Beautya.
                </label>
            </div>
        </div>

        <div class="footer-contact-row">
            <div class="footer-contact-group">
                <span><i class="fas fa-map-marker-alt"></i>Hà Nội, Việt Nam</span>
                <span><i class="fas fa-phone-alt"></i>0-123-456-789</span>
            </div>
            <div class="footer-social-group">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-pinterest"></i></a>
                <a href="#"><i class="fab fa-youtube"></i></a>
                <a href="#"><i class="fab fa-tiktok"></i></a>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="copyright">© 2025 Beautya. All Rights Reserved.</div>
            <div class="legal-links">
                <a href="#">Terms & Conditions</a>
                <a href="#">Privacy Policy</a>
            </div>
        </div>
    </footer>

    <script>
        let appliedCoupon = null;

        async function loadProvinces() {
            const res = await fetch('https://provinces.open-api.vn/api/?depth=1');
            const data = await res.json();
            const select = document.getElementById('province');
            select.innerHTML = '<option value="">-- Chọn Tỉnh / Thành phố --</option>';
            data.forEach(p => {
                const option = document.createElement('option');
                option.value = p.code;
                option.textContent = p.name;
                option.dataset.name = p.name;
                select.appendChild(option);
            });
        }

        async function loadDistricts(provinceCode) {
            const res = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
            const data = await res.json();
            const select = document.getElementById('district');
            select.innerHTML = '<option value="">-- Chọn Quận / Huyện --</option>';
            document.getElementById('ward').innerHTML = '<option value="">-- Chọn Phường / Xã --</option>';
            data.districts.forEach(d => {
                const option = document.createElement('option');
                option.value = d.code;
                option.textContent = d.name;
                select.appendChild(option);
            });
        }

        async function loadWards(districtCode) {
            const res = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
            const data = await res.json();
            const select = document.getElementById('ward');
            select.innerHTML = '<option value="">-- Chọn Phường / Xã --</option>';
            data.wards.forEach(w => {
                const option = document.createElement('option');
                option.value = w.code;
                option.textContent = w.name;
                select.appendChild(option);
            });
        }

        function applyCoupon() {
            const couponSelect = document.getElementById('coupon-code');
            const couponValue = couponSelect.value;
            const validCoupons = {
                'freeship': { type: 'freeship', value: 0 },
                'discount10k': { type: 'discount', value: 10000 }
            };

            if (couponValue && validCoupons[couponValue]) {
                appliedCoupon = validCoupons[couponValue];
                alert('Áp dụng mã giảm giá thành công!');
            } else {
                appliedCoupon = null;
                alert('Vui lòng chọn mã giảm giá hợp lệ.');
            }

            updateTotal();
        }

        function updateTotal() {
            let subtotal = 0;
            document.querySelectorAll('tbody tr').forEach(row => {
                const priceText = row.cells[1].textContent.replace('đ', '').replace('.', '');
                const price = parseInt(priceText);
                const qty = parseInt(row.querySelector('.qty-input').value);
                const itemSubtotal = price * qty;
                row.querySelector('.item-subtotal').textContent = itemSubtotal.toLocaleString() + 'đ';
                subtotal += itemSubtotal;
            });

            const selectedShipping = document.querySelector('input[name="shipping-method"]:checked');
            let shipping = selectedShipping ? parseInt(selectedShipping.value) : 0;

            const provinceSelect = document.querySelector('#province');
            const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
            const provinceName = selectedOption?.dataset.name || '';

            if (selectedShipping?.dataset.method === 'Hỏa Tốc' && provinceName !== 'Thành phố Hà Nội') {
                alert('Phương thức giao hàng Hỏa Tốc chỉ áp dụng tại Hà Nội.');
                selectedShipping.checked = false;
                document.querySelector('input[name="shipping-method"][data-method="Nhanh"]').checked = true;
                shipping = 20000;
            }

            let discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'freeship') {
                    shipping = 0;
                } else if (appliedCoupon.type === 'discount') {
                    discount = appliedCoupon.value;
                }
            }

            document.querySelector('.summary-subtotal').textContent = subtotal.toLocaleString() + 'đ';
            document.querySelector('.summary-shipping').textContent = shipping.toLocaleString() + 'đ';
            document.querySelector('.summary-discount').textContent = discount.toLocaleString() + 'đ';
            document.querySelector('.summary-total').textContent = (subtotal + shipping - discount).toLocaleString() + 'đ';
        }

        function validateOrder() {
            const name = document.getElementById('fullname').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const province = document.getElementById('province').value;
            const district = document.getElementById('district').value;
            const ward = document.getElementById('ward').value;
            const detailAddress = document.getElementById('detail-address').value.trim();
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            const qrModal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            const modalTitle = document.getElementById('modal-title');

            if (!name || !phone || !province || !district || !ward || !detailAddress || !paymentMethod) {
                alert("Vui lòng điền đầy đủ thông tin giao hàng và chọn phương thức thanh toán.");
                return false;
            }

            const phonePattern = /^0\d{9}$/;
            if (!phonePattern.test(phone)) {
                alert("Số điện thoại không hợp lệ. Vui lòng nhập đúng định dạng 10 chữ số bắt đầu bằng 0.");
                return false;
            }

            if (paymentMethod.value === 'bank') {
                modalTitle.textContent = "Quét mã QR để thanh toán qua MB Bank";
                qrImage.src = 'img/QR-bank.jpg'; // MB Bank QR code
                qrModal.style.display = 'flex';
            } else if (paymentMethod.value === 'momo') {
                modalTitle.textContent = "Quét mã QR để thanh toán qua MoMo";
                qrImage.src = 'img/QR-momo.jpg'; // MoMo QR code
                qrModal.style.display = 'flex';
            } else if (paymentMethod.value === 'cod') {
                alert("Đặt hàng thành công!");
            }

            return paymentMethod.value === 'cod'; // Chỉ return true khi là COD, còn lại giữ form mở để xem QR
        }

        function closeModal() {
            const qrModal = document.getElementById('qr-modal');
            qrModal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProvinces();

            document.getElementById('province').addEventListener('change', function () {
                loadDistricts(this.value);
                updateTotal();
            });

            document.getElementById('district').addEventListener('change', function () {
                loadWards(this.value);
            });

            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('input', updateTotal);
            });

            document.querySelectorAll('input[name="shipping-method"]').forEach(input => {
                input.addEventListener('change', updateTotal);
            });

            updateTotal();

            // Đóng modal khi nhấn ra ngoài vùng modal-content
            window.onclick = function(event) {
                const qrModal = document.getElementById('qr-modal');
                if (event.target === qrModal) {
                    qrModal.style.display = 'none';
                }
            };
        });
    </script>
</body>
</html>