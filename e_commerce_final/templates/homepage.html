<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
  <title>Beautya - Skincare & Makeup</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.9" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="{% static 'img/unsplash_HvkDYluePqw.png' %}" alt="LOGO">
      <span class="shop-name">BEAUTYA</span>
    </div>

    <nav class="nav-menu">
      <a href="{% url 'home' %}" class="nav-link">Home</a>
      <a href="{% url 'product_list' %}" class="nav-link">Products</a>
      <a href="{% url 'about' %}" class="nav-link">About Us</a>
      <a href="{% url 'contact' %}" class="nav-link">Contacts</a>

      {% if not request.user.is_authenticated %}
      <a href="{% url 'login' %}" class="nav-link">Sign in</a>
      {% else %}
      <a href="{% url 'logout' %}" class="nav-link">Logout</a>
      {% endif %}
    </nav>

    <div class="header-actions">
      <div class="cart-wrapper">
        <i class="fas fa-shopping-cart cart-icon" onclick="goToCart()"></i>
        <span class="cart-count">0</span>
      </div>
      <i class="fa-solid fa-magnifying-glass search-icon" onclick="toggleSearchBar()"></i>

      {% if request.user.is_authenticated %}
      <a href="{% url 'profile' %}" class="user-name">
        <i class="fas fa-user"></i> {{ request.user.get_full_name|default:request.user.username }}
      </a>
      {% endif %}
    </div>
  </header>


  <!-- Hidden Search Bar (will be shown on icon click) -->
  <div id="search-bar-wrapper" style="display: none; padding: 12px; background-color: #f3f3f3; text-align: center;">
    <form method="get" action="{% url 'search' %}" style="display: inline-flex; gap: 8px;">
      <input type="text" name="q" placeholder="Tìm kiếm sản phẩm..." required
        style="padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 4px;">
      <button type="submit"
        style="padding: 8px 16px; background-color: #8B4513; color: white; border: none; border-radius: 4px;">
        Tìm
      </button>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    function goToCart() {
      window.location.href = "{% url 'cart' %}";
    }

    function toggleSearchBar() {
      const wrapper = document.getElementById('search-bar-wrapper');
      if (wrapper.style.display === 'none') {
        wrapper.style.display = 'block';
      } else {
        wrapper.style.display = 'none';
      }
    }
  </script>

  <!-- Hero Slider -->
  <section class="hero-slider">
    <div class="slideshow-wrapper">
      {% for slide in hero_slides %}
      <div class="slide">
        <img src="{{ slide.image.url }}" alt="{{ slide.name }}">
      </div>
      {% endfor %}
    </div>

    <div class="hero-content">
      <h1 class="hero-title">Unlock your natural glow</h1>
      <a href="#" class="button button-outline">Xem Thêm</a>
    </div>

    <!-- Navigation arrows -->
    <div class="slider-arrow" style="left: 20px; top: 50%" onclick="moveSlide(-1)">
      <i class="fas fa-chevron-left"></i>
    </div>
    <div class="slider-arrow" style="right: 20px; top: 50%" onclick="moveSlide(1)">
      <i class="fas fa-chevron-right"></i>
    </div>
  </section>

  <!-- Dots navigation -->
  <div class="slider-dots-outside">
    {% for slide in hero_slides %}
    <span class="dot {% if forloop.first %}active{% endif %}" onclick="currentSlide('{{ forloop.counter0 }}')"></span>
    {% endfor %}
  </div>



  <!-- Categories -->
  <section>
    <h2 class="section-header">Danh Mục Sản Phẩm</h2>
    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      {% for category in categories %}
      <a href="{% url 'product_by_category' category.id %}" class="category-card"
        style="text-align: center; text-decoration: none; color: inherit;">
        <img src="{{ category.image.url }}" alt="{{ category.name }}">
        <div class="category-name">{{ category.name }}</div>
      </a>
      {% endfor %}
    </div>
  </section>

  {% if analysis %}
  <section class="virtual-analysis-section" style="display: flex; gap: 40px; padding: 40px;">
    <!-- Phần nội dung -->
    <div class="analysis-content" style="flex: 1;">
      <h3>{{ analysis.title }}</h3>
      <p>{{ analysis.description|linebreaksbr }}</p>

      <div class="scan-options" style="margin: 20px 0;">
        <div class="scan-text">Scan with your phone to get started or</div>
      </div>

      <!-- Nút mở popup -->
      <a href="javascript:void(0);" onclick="openQuizModal()" class="button button-outline">
        Answer a few questions
      </a>

      <div style="margin-top: 20px;">
        <img src="{{ analysis.qr_code.url }}" alt="QR Code" class="qr-code" style="width: 150px;">
      </div>
    </div>

    <!-- Phần hình ảnh -->
    <div class="analysis-image-wrapper" style="flex: 1;">
      <img src="{{ analysis.image.url }}" alt="Virtual Skincare" class="main-image"
        style="width: 100%; border-radius: 10px;">
    </div>
  </section>
  {% endif %}


  <!-- Best Sellers -->
  <section class="product-section">
    <h2 class="section-header">Best Sellers</h2>

    <div class="product-slider-container">
      <!-- Left Arrow -->
      <button class="product-slider-nav left" onclick="scrollProducts(-1)">
        <span class="nav-arrow-icon"></span>
      </button>

      <!-- Product Slider -->
      <div class="product-slider" id="productSlider">
        <div class="product-grid">
          {% for product in best_sellers %}
          <div class="product-card">
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
            <div class="product-info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p>{{ product.description|truncatewords:15 }}</p>
              <div class="product-price">₫{{ product.price }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Right Arrow -->
      <button class="product-slider-nav right" onclick="scrollProducts(1)">
        <span class="nav-arrow-icon"></span>
      </button>
    </div>
  </section>

  <section class="product-section dark-bg">
    <h2 class="section-header" style="color: white">New In</h2>

    <div class="product-slider-container">
      <button class="product-slider-nav left" onclick="scrollNewProducts(-1)">
        <span class="nav-arrow-icon"></span>
      </button>

      <div class="product-slider" id="newProductSlider">
        <div class="product-grid">
          {% for product in new_products %}
          <div class="product-card">
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
            <div class="product-info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p>{{ product.description|truncatewords:15 }}</p>
              <div class="product-price">₫{{ product.price }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <button class="product-slider-nav right" onclick="scrollNewProducts(1)">
        <span class="nav-arrow-icon"></span>
      </button>
    </div>
  </section>


  <!-- Special Offers -->
  {% if special_offer %}
  <section class="special-offers-section">
    <div class="special-offers-container">
      <!-- Right: Image -->
      <div class="special-offers-image">
        <img src="{{ special_offer.image.url }}" alt="Special Offer" />
      </div>

      <!-- Left: Text -->
      <div class="special-offers-content">
        <h3 class="special-offers-subtitle">{{ special_offer.subtitle }}</h3>
        <h2 class="special-offers-title">{{ special_offer.title }}</h2>

        <p class="special-offers-text">
          {{ special_offer.description|linebreaksbr }}
        </p>

        <p class="special-offers-highlight">
          {{ special_offer.highlight }}
        </p>
        <br />
      </div>
    </div>
  </section>
  {% endif %}



  <section class="blog-section">
    <div class="blog-header">
      <h2 class="section-header">Blog Làm Đẹp</h2>
      <a href="{% url 'blog_list' %}" class="button">Xem thêm</a>
    </div>

    <div class="blog-grid">
      {% for post in latest_posts %}
      <div class="blog-card">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}">
        {% else %}
        <img src="{% static 'images/default-blog.jpg' %}" alt="No image">
        {% endif %}

        <div class="blog-content">
          <div class="blog-meta">
            {% if post.category %}<span>{{ post.category }}</span>{% endif %}
            <span>•</span>
            <span>{{ post.author }}</span>
            <span>•</span>
            <span>{{ post.date|date:"d/m/Y" }}</span> {# Sửa từ created_at → date #}
          </div>
          <h3 class="blog-title">{{ post.title }}</h3>
          <p class="blog-excerpt">
            {{ post.content|truncatechars:120 }} {# Không có excerpt nên dùng content #}
          </p>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>




  <!-- Footer -->
  <footer>
    <!-- Footer Top -->
    <div class="footer-top">
      <div class="benefit-item">
        <i class="fas fa-paw benefit-icon"></i>
        <span class="benefit-text">Không thử nghiệm trên động vật</span>
      </div>
      <div class="benefit-item">
        <i class="fas fa-leaf benefit-icon"></i>
        <span class="benefit-text">Không có thành phần từ động vật</span>
      </div>
      <div class="benefit-item">
        <i class="fas fa-bread-slice benefit-icon"></i>
        <span class="benefit-text">Không có gluten, hoặc sản phẩm phụ từ gluten</span>
      </div>
      <div class="benefit-item">
        <i class="fas fa-recycle benefit-icon"></i>
        <span class="benefit-text">Bao bì có thể tái chế</span>
      </div>
    </div>

    <!-- Footer Main -->
    <div class="footer-main">
      <div class="footer-column">
        <h3>Chúng tôi có thể giúp gì?</h3>
        <ul>
          <li><a href="#">Beautya branches</a></li>
          <li><a href="#">Contact Us</a></li>
          <li><a href="FAQ.html">FAQ</a></li>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Blog</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Products</h3>
        <ul>
          <li><a href="#">Chính Sách Bảo Mật</a></li>
          <li><a href="#">Chính Sách Bảo Hành</a></li>
          <li><a href="#">Trả Hàng/Hoàn Tiền</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Giữ liên lạc với Beautya</h3>
        <p style="color: white; margin-bottom: 24px">
          Hãy tham gia nhận bản tin của Beautya để là người đầu tiên biết về tin tức, ưu đãi và lời khuyên chăm sóc da.
        </p>
        <form class="newsletter-form">
          <input type="email" placeholder="Email" class="newsletter-input" />
          <button type="submit" class="newsletter-submit">Subscribe</button>
        </form>
        <label class="consent-text">
          <input type="checkbox" required>
          Bằng cách gửi email của bạn, bạn đồng ý nhận các email quảng cáo từ Beautya.
        </label>
      </div>
    </div>
    </div>

    <div class="footer-contact-row">
      <div class="footer-contact-group">
        <span><i class="fas fa-map-marker-alt"></i>Hà Nội, Việt Nam</span>
        <span><i class="fas fa-phone-alt"></i>0-123-456-789</span>
      </div>
      <div class="footer-social-group">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-pinterest"></i></a>
        <a href="#"><i class="fab fa-youtube"></i></a>
        <a href="#"><i class="fab fa-tiktok"></i></a>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
      <div class="copyright">© 2025 Beautya. All Rights Reserved.</div>
      <div class="legal-links">
        <a href="#">Terms & Conditions</a>
        <a href="#">Privacy Policy</a>
      </div>
    </div>
  </footer>

  <!-- Modal HTML -->
  <div id="quizModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeQuizModal()">&times;</span>
      <h2>Skincare Quiz</h2>
      <form id="quizForm" method="post">
        {% csrf_token %}

        <!-- Câu 1 -->
        <label for="skin_type">Your Skin Type:</label>
        <select name="q1_skin_type" id="skin_type" required>
          <option value="">--Select--</option>
          <option value="normal">Normal</option>
          <option value="oily">Oily</option>
          <option value="dry">Dry</option>
          <option value="combination">Combination</option>
          <option value="sensitive">Sensitive</option>
        </select>

        <!-- Câu 2 -->
        <label for="concern">Main Skin Concern:</label>
        <select name="q2_concern" id="concern" required>
          <option value="">--Select--</option>
          <option value="acne">Acne</option>
          <option value="dark spots">Dark Spots</option>
          <option value="aging">Aging</option>
          <option value="redness">Redness/Irritation</option>
          <option value="dullness">Dull Skin</option>
        </select>

        <!-- Câu 3 -->
        <label for="cleanse_frequency">How often do you cleanse your face daily?</label>
        <select name="q3_cleanse_frequency" id="cleanse_frequency" required>
          <option value="">--Select--</option>
          <option value="once">Once</option>
          <option value="twice">Twice</option>
          <option value="more">More than twice</option>
          <option value="rarely">Rarely</option>
        </select>

        <!-- Câu 4 -->
        <label for="sunscreen">Do you wear sunscreen daily?</label>
        <select name="q4_sunscreen" id="sunscreen" required>
          <option value="">--Select--</option>
          <option value="yes">Yes</option>
          <option value="sometimes">Sometimes</option>
          <option value="no">No</option>
        </select>

        <!-- Câu 5 -->
        <label for="fragrance_free">Do you prefer fragrance-free products?</label>
        <select name="q5_fragrance_free" id="fragrance_free" required>
          <option value="">--Select--</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
          <option value="no_preference">No Preference</option>
        </select>

        <!-- Câu 6 -->
        <label for="active_ingredients">Do you currently use any active ingredients?</label>
        <select name="q6_active_ingredients" id="active_ingredients" required>
          <option value="">--Select--</option>
          <option value="retinol">Retinol</option>
          <option value="aha_bha">AHA/BHA</option>
          <option value="vitamin_c">Vitamin C</option>
          <option value="niacinamide">Niacinamide</option>
          <option value="none">None</option>
        </select>

        <!-- Câu 7 -->
        <label for="routine_level">How would you describe your current skincare routine?</label>
        <select name="q7_routine_level" id="routine_level" required>
          <option value="">--Select--</option>
          <option value="beginner">Beginner</option>
          <option value="basic">Basic (Cleanser + Moisturizer)</option>
          <option value="intermediate">Intermediate (Includes actives)</option>
          <option value="advanced">Advanced (Full multi-step routine)</option>
        </select>

        <button type="submit">Get My AI Recommendation</button>
      </form>

      <!-- AI output -->
      <div id="quizResult"></div>
    </div>
  </div>
  <script>
    document.getElementById("quizForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const form = event.target;

      const answers = [
        form.q1_skin_type.value,
        form.q2_concern.value,
        form.q3_cleanse_frequency.value,
        form.q4_sunscreen.value,
        form.q5_fragrance_free.value,
        form.q6_active_ingredients.value,
        form.q7_routine_level.value
      ];

      // Kiểm tra nếu thiếu câu trả lời nào
      if (answers.includes("")) {
        document.getElementById("quizResult").innerHTML = "<p style='color:red;'>Please answer all questions before submitting.</p>";
        return;
      }

      fetch("{% url 'virtual_quiz_ajax' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ answers: answers })
      })
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById("quizResult");

          if (data.error) {
            resultDiv.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
            return;
          }

          // Hiển thị phản hồi từ AI
          let html = `<h3>AI Recommendation</h3><p>${data.recommendation}</p>`;

          if (data.products && data.products.length > 0) {
            html += `<h4>Recommended Products:</h4><div class="product-list" style="display: flex; gap: 1rem; flex-wrap: wrap;">`;

            data.products.forEach(p => {
              html += `
          <div class="product-card" style="border: 1px solid #ccc; padding: 10px; width: 160px; text-align: center;">
            <img src="${p.image}" alt="${p.name}" style="width: 100px; height: 100px; object-fit: cover;">
            <p><strong>${p.name}</strong></p>
            <p>${p.price} VND</p>
          </div>
        `;
            });

            html += `</div>`;
          }

          resultDiv.innerHTML = html;
        })
        .catch(error => {
          document.getElementById("quizResult").innerHTML = `<p style="color:red;">An error occurred: ${error}</p>`;
        });
    });
  </script>



  <script src="include.js"></script>
  <script>
    // Hero Slider functionality
    let slideIndex = 0;
    const slides = document.querySelectorAll(".slide");
    const dots = document.querySelectorAll(".dot");
    const wrapper = document.querySelector(".slideshow-wrapper");

    function showSlide(n) {
      if (n >= slides.length) slideIndex = 0;
      if (n < 0) slideIndex = slides.length - 1;

      wrapper.style.transform = `translateX(-${slideIndex * 100}%)`;

      dots.forEach((dot, i) => {
        dot.classList.toggle("active", i === slideIndex);
      });
    }

    function moveSlide(n) {
      showSlide((slideIndex += n));
    }

    function currentSlide(n) {
      showSlide((slideIndex = n));
    }

    // Auto slide
    let slideInterval = setInterval(() => moveSlide(1), 3000);

    // Pause on hover
    const slideshow = document.querySelector(".hero-slider");
    slideshow.addEventListener("mouseenter", () =>
      clearInterval(slideInterval)
    );
    slideshow.addEventListener("mouseleave", () => {
      slideInterval = setInterval(() => moveSlide(1), 3000);
    });

    // Initialize
    showSlide(slideIndex);

    // Slider functionality for both Best Sellers and New In
    function setupSlider(sliderId) {
      const slider = document.getElementById(sliderId);
      const productGrid = slider.querySelector('.product-grid');
      const cards = productGrid.querySelectorAll('.product-card');
      const cardWidth = cards[0].offsetWidth + 24; // card width + gap
      const visibleCards = 4;
      let currentIndex = 0;
      const totalCards = cards.length;

      function scrollSlider(direction) {
        currentIndex += direction;

        // Handle wrapping around
        if (currentIndex >= totalCards - visibleCards + 1) {
          currentIndex = 0;
        } else if (currentIndex < 0) {
          currentIndex = totalCards - visibleCards;
        }

        productGrid.style.transition = 'transform 0.5s ease';
        productGrid.style.transform = `translateX(-${currentIndex * cardWidth}px)`;
      }

      return scrollSlider;
    }

    const scrollProducts = setupSlider('productSlider');
    const scrollNewProducts = setupSlider('newProductSlider');

    // Make sliders responsive
    window.addEventListener('resize', function () {
      // Reset sliders on resize
      document.querySelectorAll('.product-grid').forEach(grid => {
        grid.style.transition = 'none';
        grid.style.transform = 'translateX(0)';
        // Force reflow
        void grid.offsetWidth;
        grid.style.transition = 'transform 0.5s ease';
      });
    });

    // Newsletter form submission
    newsletterForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const emailInput = this.querySelector('input[type="email"]');
      fetch("{% url 'subscribe_newsletter' %}", {
        method: "POST",
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `email=${encodeURIComponent(emailInput.value)}`
      })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(err => alert("Error subscribing."));
    });



    // include.js
    function includeHTML() {
      const elements = document.querySelectorAll('[data-include]');
      elements.forEach(el => {
        const file = el.getAttribute('data-include');
        fetch(file)
          .then(response => {
            if (response.ok) return response.text();
            throw new Error('Page not found');
          })
          .then(data => el.innerHTML = data)
          .catch(err => console.error('Error including HTML:', err));
      });
    }
    document.addEventListener('DOMContentLoaded', includeHTML);

    function openQuizModal() {
      document.getElementById("quizModal").style.display = "block";
    }
    function closeQuizModal() {
      document.getElementById("quizModal").style.display = "none";
    }

    // Gửi form qua AJAX
    document.getElementById('quizForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);

      fetch("{% url 'virtual_quiz_ajax' %}", {
        method: "POST",
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: data
      })
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById('quizResult');
          if (data.recommended && data.recommended.length > 0) {
            resultDiv.innerHTML = "<h4>Recommended Products:</h4><ul>" +
              data.recommended.map(p => `<li><a href="/product/${p.id}/">${p.name}</a></li>`).join('') +
              "</ul>";
          } else {
            resultDiv.innerHTML = "<p>No matching products found.</p>";
          }
        });
    });


  </script>
</body>

</html>